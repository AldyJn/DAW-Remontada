<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{layout/layout :: head}"></head>
<body>

<header th:replace="~{layout/layout :: header}"></header>

<div class="container py-4">
    <div class="card">
        <div class="card-header" th:text="${titulo}"></div>
        <div class="card-body">

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="card-title mb-0">
                    <button sec:authorize="hasRole('ROLE_ADMIN')"
                       class="btn btn-success" onclick="abrirModalCrear()">
                        <i class="bi bi-plus-circle"></i> <span th:text="#{text.boton.crear}">Crear Alumno</span>
                    </button>
                </h4>
                <div class="btn-group" role="group" th:if="${alumnos != null and !alumnos.isEmpty()}">
                    <a th:href="@{/listar(format=pdf)}" class="btn btn-danger" title="Exportar a PDF">
                        <i class="bi bi-file-pdf"></i> PDF
                    </a>
                    <a th:href="@{/listar(format=xls)}" class="btn btn-success" title="Exportar a Excel">
                        <i class="bi bi-file-excel"></i> Excel
                    </a>
                </div>
            </div>

            <div class="alert alert-info" th:if="${alumnos == null or alumnos.isEmpty()}">
                <i class="bi bi-info-circle"></i> No hay alumnos en la base de datos!
            </div>

            <div class="table-responsive" th:if="${alumnos != null and !alumnos.isEmpty()}">
                <table id="tablaAlumnos" class="table table-striped table-bordered table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th sec:authorize="hasRole('ROLE_USER')" style="width: 10%;">ID</th>
                            <th sec:authorize="hasRole('ROLE_USER')" style="width: 50%;">Nombre</th>
                            <th sec:authorize="hasRole('ROLE_USER')" style="width: 15%;">Créditos</th>
                            <th sec:authorize="hasRole('ROLE_ADMIN')" style="width: 25%;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="alumno: ${alumnos}" th:id="'fila-' + ${alumno.id}">
                            <td th:text="${alumno.id}" th:data-id="${alumno.id}"></td>
                            <td th:text="${alumno.nombre}" class="nombre-cell"></td>
                            <td th:text="${alumno.creditos}" class="creditos-cell"></td>
                            <td sec:authorize="hasRole('ROLE_ADMIN')">
                                <button class="btn btn-primary btn-sm"
                                   th:onclick="'abrirModalEditar(' + ${alumno.id} + ')'"
                                   title="Editar alumno">
                                    <i class="bi bi-pencil"></i> Editar
                                </button>
                                <button class="btn btn-danger btn-sm"
                                   th:onclick="'abrirModalEliminar(' + ${alumno.id} + ', \'' + ${alumno.nombre} + '\')'"
                                   title="Eliminar alumno">
                                    <i class="bi bi-trash"></i> Eliminar
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para Crear/Editar Alumno -->
    <div class="modal fade" id="modalAlumno" tabindex="-1" aria-labelledby="modalAlumnoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalAlumnoLabel">
                        <i class="bi bi-person-plus"></i> Crear Alumno
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formAlumno">
                        <input type="hidden" id="alumnoId">

                        <div class="mb-3">
                            <label for="alumnoNombre" class="form-label">
                                <i class="bi bi-person"></i> Nombre
                            </label>
                            <input type="text" class="form-control" id="alumnoNombre"
                                   placeholder="Ingrese el nombre del alumno"
                                   required minlength="3" maxlength="100">
                            <div class="invalid-feedback" id="errorNombre"></div>
                        </div>

                        <div class="mb-3">
                            <label for="alumnoCreditos" class="form-label">
                                <i class="bi bi-award"></i> Créditos
                            </label>
                            <input type="number" class="form-control" id="alumnoCreditos"
                                   placeholder="Ingrese los créditos"
                                   required min="0" max="100">
                            <div class="invalid-feedback" id="errorCreditos"></div>
                            <small class="form-text text-muted">Valor entre 0 y 100</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="guardarAlumno()">
                        <i class="bi bi-save"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Confirmar Eliminación -->
    <div class="modal fade" id="modalEliminar" tabindex="-1" aria-labelledby="modalEliminarLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modalEliminarLabel">
                        <i class="bi bi-exclamation-triangle"></i> Confirmar Eliminación
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro que deseas eliminar este alumno?</p>
                    <div class="alert alert-warning">
                        <strong>Nombre:</strong> <span id="eliminarNombre"></span><br>
                        <strong>ID:</strong> <span id="eliminarId"></span>
                    </div>
                    <p class="text-danger"><strong>Esta acción no se puede deshacer.</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmarEliminar()">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{layout/layout :: footer}"></footer>

<script th:src="@{/js/script.js}"></script>
</body>
</html>
